<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>LHI Lecce NFT - Un Valore Reale per la Ricerca</title>
    <meta name="description" content="Sostieni la ricerca acquistando un NFT LHI, un valore digitale ancorato a un bene immobiliare da 10 milioni di euro.">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js" defer></script>
    <script src="abi.js"></script>
    <style>
        html { scroll-behavior: smooth; }
        body { background-color: #f0fff0; font-family: Arial, sans-serif; padding: 15px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2, h3 { text-align: center; color: #00796b; }
        h1 { font-size: 1.8em; }
        h2 { font-size: 1.4em; font-weight: normal; }
        h3 { font-size: 1.2em; }
        a { color: #00796b; font-weight: bold; text-decoration: none; }
        a:hover { text-decoration: underline; }
        .header, .footer-header { padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid #ccc; }
        .header a, .footer-header a { margin: 0 15px; }
        .banner img { width: 100%; height: auto; border-radius: 8px; margin-bottom: 20px; }
        .image-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 25px 0; }
        .image-row img { width: 100%; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .text-box { background-color: #e8f5e9; color: magenta; padding: 5px 20px; margin: 25px 0; border-radius: 8px; line-height: 1.6; }
        .text-box h3 { color: #004d40; text-align: left; }
        .minting-section { text-align: center; padding: 30px; background-color: #f0f7f8; margin-top: 30px; border-radius: 12px; }
        .nft-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; margin-top: 20px; }
        .nft-card { text-align: center; border: 1px solid #b2dfdb; border-radius: 8px; padding: 15px; background-color: #fafafa; }
        .nft-card img { max-width: 100%; height: auto; border-radius: 5px; }
        .nft-card p { font-weight: bold; margin: 10px 0 5px 0; color: #004d40; }
        .mint-controls { margin-top: 10px; }
        .mint-controls input { width: 60px; padding: 8px; text-align: center; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
        .mint-button { width: 100%; padding: 8px 15px; font-size: 14px; cursor: pointer; background-color: #00796b; color: white; border: none; border-radius: 5px; transition: all 0.3s ease; }
        .mint-button:disabled { background-color: #aaa; cursor: not-allowed; }
        .mint-button:hover:not(:disabled) { background-color: #004d40; }
        .mint-button.loading { background-color: #ff9800; }
        .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .success { color: #2e7d32; }
        .error { color: #d32f2f; }
        .warning { color: #f57c00; }
        .info { color: #1976d2; }
        .network-status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .network-status.polygon { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #4caf50; }
        .network-status.wrong-network { background-color: #fff3e0; color: #f57c00; border: 1px solid #ff9800; }
        .network-status.error { background-color: #ffebee; color: #d32f2f; border: 1px solid #f44336; }
        .global-wallet-section { margin-top: 40px; text-align: center; }
        #connect-btn { padding: 12px 25px; font-size: 18px; cursor: pointer; background-color: #004d40; color: white; border: none; border-radius: 5px; }
        #connect-btn:disabled { background-color: #6c757d; }
        #log { margin-top: 15px; font-style: italic; font-weight: bold; }
        .warning { color: #d32f2f; font-weight: bold; margin-bottom: 15px; border: 1px solid #ffcdd2; padding: 10px; border-radius: 5px; background-color: #ffebed;}
        .about-us-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; text-align: left; }
        .about-us-section h2 { text-align: center; }
        .about-us-section ul { list-style: none; padding: 0; }
        .about-us-section li { margin-bottom: 5px; }
        .footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 0.9em; color: #555; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>LHI LECCE MEDICAL HOTEL ITALIA</h1>
        <h2><a href="https://lhilecce.it" target="_blank">Sito Ufficiale</a> | <a href="https://polygonscan.com/address/0x2a4364c0E9fc125D831257b289b70b0B16A02315" target="_blank">Smart Contract Verificato</a></h2>
        <h1>Token NFT Solidali - Progetto Scientifico: DEPRESSIONE: Cura e Guarigione</h1>
    </div>

    <div class="banner">
        <img src="images/banner.png" alt="Banner LHI Lecce">
    </div>

    <div class="text-box">
        <h3>Un Progetto Reale, un Valore Tangibile</h3>
        <p>A differenza di molti progetti digitali, il valore di un NFT LHI non è astratto. È direttamente collegato a un <strong>bene immobile e reale del valore di 10 milioni di euro</strong>: la struttura del Medical Hotel a Lecce. Questa imponente struttura di <strong>7 piani</strong> (4.000 mq) è il risultato di <strong>20 anni di lavoro</strong> e dell'investimento di decine di famiglie. La sua posizione strategica, di fronte ai poli ospedalieri di Lecce, le conferisce un ruolo centrale nell'ospitalità sanitaria.</p>
    </div>

    <div class="image-row">
        <img src="images/05.jpg" alt="NFT 5"><img src="images/10.jpg" alt="NFT 10"><img src="images/15.jpg" alt="NFT 15"><img src="images/20.jpg" alt="NFT 20">
    </div>

    <div class="text-box">
        <h3>Un Valore Destinato a Crescere nel Benessere</h3>
        <p>Il valore del tuo NFT è destinato a crescere con l'eccellenza dei servizi offerti. LHI vuole essere anche un **centro di sollievo dalla sofferenza**, offrendo una piscina con acqua di mare purissima estratta a 350 metri di profondità per talassoterapia, sauna e servizi di riabilitazione. Sostenere questo progetto significa investire in un ecosistema di benessere reale.</p>
    </div>

    <div class="image-row">
        <img src="images/25.jpg" alt="NFT 25"><img src="images/30.jpg" alt="NFT 30"><img src="images/35.jpg" alt="NFT 35"><img src="images/40.jpg" alt="NFT 40">
    </div>

    <div class="text-box">
        <h3>La Nostra Zecca Digitale: Sicurezza e Affidabilità</h3>
        <p>Il nostro Smart Contract agisce come una **Zecca Digitale**. È costruito sulla blockchain Polygon usando gli strumenti più robusti e moderni, garantendo che ogni NFT sia irripetibile, non falsificabile e immutabile.</p>
    </div>

    <div class="image-row">
        <img src="images/45.jpg" alt="NFT 45"><img src="images/50.jpg" alt="NFT 50"><img src="images/55.jpg" alt="NFT 55"><img src="images/60.jpg" alt="NFT 60">
    </div>

    <div class="text-box">
        <h3>Il Tuo NFT: Bene Unico con Certificato di Proprietà</h3>
        <p>Quando clicchi "Mint", la nostra Zecca Digitale crea un bene virtuale solo per te. Ogni "Mint" genera un "Certificato di Nascita" (la transazione sulla blockchain) e un "Certificato di Residenza" (la proprietà registrata sul tuo wallet), garantendoti il pieno e verificabile possesso del tuo asset digitale.</p>
    </div>

    <div class="image-row">
        <img src="images/65.jpg" alt="NFT 65"><img src="images/70.jpg" alt="NFT 70"><img src="images/75.jpg" alt="NFT 75"><img src="images/80.jpg" alt="NFT 80">
    </div>

    <div class="text-box">
        <h3>Un Progetto per la Ricerca Scientifica</h3>
        <p>Acquistando un NFT, non solo entri in possesso di un asset digitale di valore, ma finanzi direttamente la ricerca scientifica su Depressione e Fibromialgia, contribuendo a un obiettivo di immenso valore sociale.</p>
    </div>

    <div class="image-row">
        <img src="images/85.jpg" alt="NFT 85"><img src="images/90.jpg" alt="NFT 90"><img src="images/95.jpg" alt="NFT 95"><img src="images/100.jpg" alt="NFT 100">
    </div>

    <div class="footer-header">
        <h2><a href="https://lhilecce.it" target="_blank">Sito Ufficiale LHI LECCE</a> | <a href="https://polygonscan.com/address/0x2a4364c0E9fc125D831257b289b70b0B16A02315" target="_blank">Smart Contract Verificato di Garanzia</a></h2>
    </div>

    <div class="about-us-section">
        <h2>Chi Siamo</h2>
        <p><strong>LHI è una Società per Azioni</strong> iscritta alla Camera di Commercio di Lecce - Italia con il n. REA LE - 210133.</p>
        <p><strong>Proprietà LHI Spa</strong>, sede Via Giorgio di Lecce, nr 7 LECCE, n. iscr. Reg. Imprese 03223970751.</p>
        <p>La gestione della struttura immobiliare è affidata a <strong>Santa Rita Gestioni Spa</strong>, con sede in Maglie (LE), Piazza della Repubblica nr 15 (n. iscrizione 04732500758).</p>
        <h3>Team e Collaboratori</h3>
        <ul>
            <li><strong>Presidente del CdA:</strong> Dott.ssa Cinzia Colizzi (Dottore Commercialista)</li>
            <li><strong>Responsabile dei lavori:</strong> dott. Antonio Primiceri</li>
            <li><strong>Direttore dei Lavori:</strong> ing. Donato Nocco, ing. Pietro Licignano, ing. Roberto Paladini</li>
            <li><strong>Coordinatore Sicurezza Esecuzione:</strong> ing. Roberto Paladini</li>
            <li><strong>Progettisti Architettonici:</strong> arch. Angelo Ingrosso, ing. Pietro Licignano</li>
            <li><strong>Progettisti Strutture:</strong> ing. Donato Nocco e ing. Livio Calo'</li>
            <li><strong>Progettisti Impianti:</strong> p.ti ind.li Antonio Laurenti, Piero Romano, Giuseppe Serafino, Sandro Ciurlia, Giuseppe Martella</li>
            <li><strong>Collaudatori:</strong> ing. Vito Morciano, ing. Giuseppe Bruno</li>
        </ul>
        <h3>Partner Finanziari e Contributi</h3>
        <p>Il progetto è stato realizzato con il contributo della <strong>Regione Puglia programma Operativo Puglia FESR 2014-2020</strong>, <strong>Monte dei Paschi Siena, Capital Service di Firenze</strong>, la <strong>Banca Popolare Pugliese</strong> e la <strong>Banca di Credito Cooperativo di Terra d'Otranto</strong>. Con il supporto tecnico per il <strong>Protocollo Itaca Puglia:</strong> 2011 (ing. Roberto Paladini) e 2017 (prof. ing. [...]).</p>
    </div>

    <div class="minting-section">
        <h2>Acquista il Tuo NFT</h2>
        <div class="global-wallet-section">
            <p class="warning">⚠ IMPORTANTE: Esegui il MINT dentro l'App MetaMask. Controlla di avere MATIC sufficienti a coprire il costo dell'NFT più le commissioni di gas.</p>
            <div id="network-status" class="network-status" style="display: none;" aria-live="polite"></div>
            <button id="connect-btn" aria-label="Connetti il tuo wallet MetaMask per iniziare">🔗 Connetti MetaMask</button>
            <p id="log" aria-live="polite">Status: In attesa di connessione...</p>
            <div id="user-balance" style="display: none; margin-top: 10px; font-weight: bold;" aria-live="polite"></div>
        </div>
        <div class="nft-grid" id="nft-grid-container"></div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 Web Master Avv. Marcello Stanca - Firenze. Tutti i diritti riservati.</p>
        <p>Realizzato in collaborazione con AI Gemini di Google (Giugno 2025).</p>
    </footer>
</div>

<script>
    const contractAddress = "0x2a4364c0E9fc125D831257b289b70b0B16A02315";
    const POLYGON_MAINNET_CHAIN_ID = '0x89'; // 137 in decimal
    const POLYGON_MAINNET_CONFIG = {
        chainId: '0x89',
        chainName: 'Polygon Mainnet',
        nativeCurrency: {
            name: 'MATIC',
            symbol: 'MATIC',
            decimals: 18
        },
        rpcUrls: ['https://polygon-rpc.com'],
        blockExplorerUrls: ['https://polygonscan.com/']
    };
    
    // Robust ABI loading control
    let contractABI;
    function checkABILoading() {
        if (typeof window.CONTRACT_ABI === 'undefined' || !window.CONTRACT_ABI) {
            console.error("ABI non caricata! Controlla che abi.js sia referenziato correttamente.");
            updateLog("Errore: ABI del contratto non caricata. Ricarica la pagina.", true);
            return false;
        }
        contractABI = window.CONTRACT_ABI;
        console.log("ABI caricata correttamente:", contractABI.length, "metodi disponibili");
        return true;
    }

    // NFT array definition
    const nfts = Array.from({ length: 20 }, (_, i) => {
        const tokenId = (i + 1) * 5;
        return { id: tokenId };
    });

    let userAccount, contractInstance, provider;
    const logElement = document.getElementById('log');
    const networkStatusElement = document.getElementById('network-status');
    const userBalanceElement = document.getElementById('user-balance');
    let mintingInProgress = new Set(); // Prevent multiple mint attempts

    function updateLog(message, isError = false, type = 'info') {
        logElement.textContent = `Status: ${message}`;
        logElement.className = isError ? 'error' : type;
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function updateNetworkStatus(message, status = 'info') {
        networkStatusElement.textContent = message;
        networkStatusElement.className = `network-status ${status}`;
        networkStatusElement.style.display = 'block';
    }

    function updateUserBalance(balance) {
        if (balance !== null) {
            userBalanceElement.textContent = `Saldo MATIC: ${parseFloat(balance).toFixed(4)} MATIC`;
            userBalanceElement.style.display = 'block';
            userBalanceElement.className = parseFloat(balance) > 0.01 ? 'success' : 'warning';
        } else {
            userBalanceElement.style.display = 'none';
        }
    }

    // Check and switch to Polygon network
    async function checkAndSwitchNetwork() {
        if (!window.ethereum) {
            throw new Error("MetaMask non rilevato");
        }

        try {
            const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
            console.log("Rete corrente:", currentChainId);

            if (currentChainId === POLYGON_MAINNET_CHAIN_ID) {
                updateNetworkStatus("✅ Connesso alla rete Polygon Mainnet", "polygon");
                return true;
            }

            updateNetworkStatus("⚠ Rete non corretta. Cambio alla rete Polygon...", "wrong-network");
            
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: POLYGON_MAINNET_CHAIN_ID }],
                });
                updateNetworkStatus("✅ Cambiato con successo alla rete Polygon", "polygon");
                return true;
            } catch (switchError) {
                if (switchError.code === 4902) {
                    console.log("Rete Polygon non trovata, aggiunta in corso...");
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [POLYGON_MAINNET_CONFIG],
                    });
                    updateNetworkStatus("✅ Rete Polygon aggiunta e selezionata", "polygon");
                    return true;
                } else {
                    throw switchError;
                }
            }
        } catch (error) {
            console.error("Errore nella gestione della rete:", error);
            updateNetworkStatus("❌ Errore nel cambio rete: " + error.message, "error");
            return false;
        }
    }

    // Get user balance
    async function getUserBalance() {
        if (!provider || !userAccount) return null;
        
        try {
            const balance = await provider.getBalance(userAccount);
            const balanceInEther = ethers.formatEther(balance);
            console.log("Saldo utente:", balanceInEther, "MATIC");
            return balanceInEther;
        } catch (error) {
            console.error("Errore nel recupero saldo:", error);
            return null;
        }
    }

    async function connectWallet() {
        console.log("Tentativo di connessione a MetaMask...");
        
        if (typeof window.ethereum === 'undefined') {
            console.error("MetaMask non è installato o non è attivo.");
            updateLog("Per favore, installa MetaMask per continuare.", true);
            return;
        }

        if (!checkABILoading()) {
            return;
        }

        updateLog("Connessione a MetaMask...", false, 'info');
        
        try {
            // Check and switch network first
            const networkOK = await checkAndSwitchNetwork();
            if (!networkOK) {
                updateLog("Errore: impossibile connettersi alla rete Polygon", true);
                return;
            }

            provider = new ethers.BrowserProvider(window.ethereum);
            console.log("Provider Ethers v6 creato.");
            
            await provider.send("eth_requestAccounts", []);
            console.log("Richiesta account inviata a MetaMask.");
            
            const signer = await provider.getSigner();
            userAccount = await signer.getAddress();
            console.log("Account utente connesso:", userAccount);
            
            // Get and display user balance
            const balance = await getUserBalance();
            updateUserBalance(balance);
            
            contractInstance = new ethers.Contract(contractAddress, contractABI, signer);
            console.log("Istanza contratto creata con Ethers v6.");

            const connectBtn = document.getElementById('connect-btn');
            connectBtn.textContent = `Connesso: ${userAccount.substring(0, 6)}...${userAccount.substring(userAccount.length - 4)}`;
            connectBtn.disabled = true;
            connectBtn.setAttribute('aria-label', `Wallet connesso: ${userAccount}`);
            
            document.querySelectorAll('.mint-button').forEach(btn => { 
                btn.disabled = false; 
                btn.setAttribute('aria-label', `Mint NFT ${btn.dataset.tokenId}`);
            });
            
            updateLog("Wallet connesso con successo. Puoi ora effettuare il mint.", false, 'success');
            console.log("Connessione wallet completata con successo!");
            
        } catch (err) {
            updateLog("Connessione fallita: " + (err.message || "Errore sconosciuto"), true);
            console.error("Errore di connessione MetaMask:", err);
            updateNetworkStatus("❌ Errore di connessione", "error");
        }
    }

    // Enhanced quantity validation
    function validateQuantity(quantity, tokenId) {
        const errors = [];
        
        if (isNaN(quantity)) {
            errors.push("La quantità deve essere un numero valido");
        }
        
        if (quantity <= 0) {
            errors.push("La quantità deve essere maggiore di 0");
        }
        
        if (quantity > 100) {
            errors.push("La quantità non può superare 100 NFT");
        }
        
        if (!Number.isInteger(quantity)) {
            errors.push("La quantità deve essere un numero intero");
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    async function checkUserBalanceForMint(totalCostInWei) {
        const balance = await getUserBalance();
        if (!balance) return false;
        
        const balanceInWei = ethers.parseEther(balance);
        const estimatedGas = ethers.parseEther("0.01"); // Stima conservativa per il gas
        const totalNeeded = totalCostInWei + estimatedGas;
        
        if (balanceInWei < totalNeeded) {
            const neededInEther = ethers.formatEther(totalNeeded);
            updateLog(`Saldo insufficiente. Necessari almeno ${parseFloat(neededInEther).toFixed(4)} MATIC`, true);
            return false;
        }
        
        return true;
    }

    async function mintNFT(tokenId) {
        // Prevent multiple mint attempts
        if (mintingInProgress.has(tokenId)) {
            updateLog("Mint già in corso per questo NFT. Attendi il completamento.", false, 'warning');
            return;
        }

        const quantityInput = document.getElementById(`quantity-${tokenId}`);
        const quantity = parseInt(quantityInput.value);
        const mintButton = document.getElementById(`mint-btn-${tokenId}`);

        console.log(`Tentativo di mint NFT (ID: ${tokenId}, Quantità: ${quantity})...`);
        
        if (!contractInstance) {
            console.error("Istanza contratto non disponibile. Connetti prima il wallet.");
            updateLog("Per favore, connetti prima il tuo wallet.", true);
            return;
        }

        // Enhanced quantity validation
        const validation = validateQuantity(quantity, tokenId);
        if (!validation.isValid) {
            const errorMessage = validation.errors.join("; ");
            console.error("Validazione quantità fallita:", errorMessage);
            updateLog(`Errore: ${errorMessage}`, true);
            return;
        }

        // Add to minting progress set
        mintingInProgress.add(tokenId);
        
        // Update button state with loading spinner
        mintButton.disabled = true;
        mintButton.classList.add('loading');
        mintButton.innerHTML = '<span class="spinner"></span> Mintando...';
        mintButton.setAttribute('aria-label', `Mint in corso per NFT ${tokenId}`);
        
        updateLog(`Preparazione transazione per ${quantity} NFT (ID: ${tokenId})...`, false, 'info');
        console.log("Recupero prezzo in Wei dal contratto...");

        try {
            const priceInWei = await contractInstance.pricesInWei(tokenId);
            console.log(`Prezzo per ${tokenId}: ${priceInWei.toString()} Wei.`);
            
            const totalCostInWei = priceInWei * BigInt(quantity);
            console.log(`Costo totale in Wei: ${totalCostInWei.toString()} Wei.`);
            
            // Check user balance before proceeding
            const balanceOK = await checkUserBalanceForMint(totalCostInWei);
            if (!balanceOK) {
                return;
            }

            console.log("Invio transazione di mint a MetaMask...");
            updateLog(`Invio transazione a MetaMask per ${quantity} NFT...`, false, 'info');
            
            const tx = await contractInstance.mintNFT(tokenId, quantity, { value: totalCostInWei });
            updateLog(`Transazione inviata (hash: ${tx.hash.substring(0, 10)}...). Attendo conferma...`, false, 'info');            
            console.log("Transazione hash:", tx.hash);
            
            updateLog("Attendo la conferma della transazione sulla blockchain...", false, 'info');
            await tx.wait();
            console.log("Transazione confermata sulla blockchain.");
            
            updateLog(`NFT ${tokenId} mintato con successo! Quantità: ${quantity}`, false, 'success');
            
            // Update user balance after successful mint
            const newBalance = await getUserBalance();
            updateUserBalance(newBalance);
            
            // Show success message
            alert(`🎉 Complimenti! Hai mintato con successo ${quantity} NFT (ID: ${tokenId}).`);
            
        } catch (err) {
            console.error("Errore di minting nel blocco try-catch:", err);
            let errorMessage = "Errore sconosciuto";
            
            if (err.code === 4001) {
                errorMessage = "Transazione rifiutata dall'utente";
            } else if (err.code === -32603) {
                errorMessage = "Errore interno del provider";
            } else {
                errorMessage = err.cause?.reason || err.info?.error?.message || err.reason || err.message || "Errore sconosciuto";
            }
            
            updateLog(`Errore durante il mint: ${errorMessage}`, true);
            alert(`❌ Errore durante il minting: ${errorMessage}`);
            
        } finally {
            console.log("Funzione mintNFT completata.");
            
            // Remove from minting progress set
            mintingInProgress.delete(tokenId);
            
            // Reset button state
            mintButton.disabled = false;
            mintButton.classList.remove('loading');
            mintButton.innerHTML = 'Mint NFT';
            mintButton.setAttribute('aria-label', `Mint NFT ${tokenId}`);
        }
    }

    // Enhanced window.onload with better error handling
    window.onload = function() {
        console.log("Inizializzazione applicazione...");
        
        if (!checkABILoading()) {
            return;
        }

        const gridContainer = document.getElementById('nft-grid-container');
        if (!gridContainer) {
            console.error("Container griglia NFT non trovato");
            return;
        }

        nfts.forEach(nft => {
            const card = document.createElement('div');
            card.className = 'nft-card';
            const paddedId = nft.id.toString().padStart(2, '0');
            
            card.innerHTML = `
                <img src="images/${paddedId}.jpg" alt="LHI NFT ${nft.id}" loading="lazy">
                <p>LHI ${nft.id}</p>
                <div class="mint-controls">
                    <label for="quantity-${nft.id}" class="sr-only">Quantità NFT da mintare</label>
                    <input 
                        type="number" 
                        id="quantity-${nft.id}" 
                        value="1" 
                        min="1" 
                        max="100" 
                        step="1"
                        aria-label="Quantità per NFT ${nft.id}"
                        aria-describedby="quantity-help-${nft.id}"
                    >
                    <div id="quantity-help-${nft.id}" class="sr-only">
                        Inserisci un numero da 1 a 100 per specificare quanti NFT mintare
                    </div>
                    <button 
                        class="mint-button" 
                        id="mint-btn-${nft.id}" 
                        onclick="mintNFT(${nft.id})" 
                        disabled
                        data-token-id="${nft.id}"
                        aria-label="Mint NFT ${nft.id}"
                        aria-describedby="mint-help-${nft.id}"
                    >
                        Mint NFT
                    </button>
                    <div id="mint-help-${nft.id}" class="sr-only">
                        Clicca per acquistare questo NFT. Devi prima connettere il tuo wallet MetaMask.
                    </div>
                </div>
            `;
            gridContainer.appendChild(card);
        });

        // Add event listener for connect button
        const connectBtn = document.getElementById('connect-btn');
        if (connectBtn) {
            connectBtn.addEventListener('click', connectWallet);
        }

        // Monitor network changes
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                console.log('Rete cambiata:', chainId);
                location.reload(); // Ricarica la pagina per assicurare coerenza dello stato
            });

            window.ethereum.on('accountsChanged', (accounts) => {
                console.log('Account cambiato:', accounts);
                if (accounts.length === 0) {
                    updateLog("Account disconnesso. Riconnetti il wallet.", false, 'warning');
                } else {
                    location.reload(); // Ricarica per aggiornare l'account
                }
            });
        }

        console.log("Inizializzazione completata. Pronto per la connessione del wallet.");
        updateLog("Applicazione pronta. Connetti il tuo wallet per iniziare.", false, 'info');
    };
</script>
</body>
</html>
