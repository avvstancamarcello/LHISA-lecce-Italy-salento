<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LHI Lecce NFT - Mint Frontend</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #E0FFFF; /* Sfondo celeste chiaro */
      margin: 0;
      padding: 10px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      color: #333;
    }
    .container {
      max-width: 960px;
      width: 100%;
      margin: auto;
      padding: 15px;
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    .header b {
      font-size: 1.5em;
      color: #8B0000; /* Rosso granata per LHI Lecce */
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    .header .crowdfunding-text {
        color: #0000FF; /* Blu per The First Crowdfunding International */
        font-weight: bold;
        display: block;
        font-size: 1.1em;
        margin-top: 5px;
    }
    .header .blockchain-text {
        color: #800080; /* Viola chiaro per Polygon */
        font-weight: bold;
        display: block;
        font-size: 1.0em;
        margin-top: 5px;
    }
    .scientific-project {
        text-align: center;
        margin-top: 15px;
        font-size: 0.95em;
        color: #555;
        line-height: 1.4;
    }
    .scientific-project b {
        color: #333;
    }
    .scientific-project ul {
        list-style-type: none;
        padding: 0;
        margin: 5px 0 0 0;
    }
    .scientific-project li {
        margin-bottom: 2px;
        color: #28a745; /* Verde per le cifre */
        font-weight: bold;
    }
    .call-to-action {
        font-size: 1.2em;
        font-weight: bold;
        color: #0000FF; /* Blu per la frase */
        margin-top: 20px;
        margin-bottom: 20px;
        display: block;
    }

    .link {
      display: inline-block;
      margin: 3px 8px;
      font-size: 0.9em;
      color: #007bff;
      text-decoration: none;
    }
    .link:hover {
      text-decoration: underline;
    }
    .subtitle {
      margin-top: 10px;
      font-size: 0.95em;
      line-height: 1.4;
      color: #333;
    }
    .green { color: #28a745; font-weight: bold; }
    .red { color: #dc3545; font-weight: bold; }
    .darkgreen { color: #1e7e34; font-weight: bold; }

    /* Stili per il popup */
    .popup-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #007bff;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      z-index: 100;
      text-align: center;
      padding: 20px;
      max-width: 90vw; /* Adatta alla larghezza del viewport */
      max-height: 90vh; /* Adatta all'altezza del viewport */
      overflow-y: auto; /* Scorri se il contenuto è troppo grande */
      box-sizing: border-box; /* Include padding nel calcolo della dimensione */
    }

    .popup-container img {
      max-width: 100%;
      height: auto;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .popup-container button {
      margin-top: 10px;
      font-size: 1em;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .popup-container button:hover {
      background-color: #0056b3;
    }
    .popup-container #popup-close-btn {
        background-color: #dc3545;
        margin-left: 10px;
    }
    .popup-container #popup-close-btn:hover {
        background-color: #c82333;
    }
    /* Stili per l'overlay */
    .overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6); /* Sfondo più scuro */
      z-index: 90;
    }

    #preview {
      margin: 15px auto;
      width: 80%; /* Percentuale della larghezza del contenitore */
      max-width: 200px; /* Ridotto drasticamente la dimensione massima dell'immagine per schermi piccoli */
      height: auto;
      border: 3px solid #007bff;
      border-radius: 8px;
      object-fit: contain;
      background-color: #e9ecef;
      min-height: 150px;
      display: block;
      cursor: pointer; /* Indica che è cliccabile */
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
    }
    .token-button {
      background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
      border: none;
      border-radius: 8px;
      color: #fff;
      padding: 15px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 6px rgba(0, 0, 0, 0.15);
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        line-height: 1.2;
    }
    .token-button span {
        font-size: 0.8em;
        display: block;
    }
    .token-button.selected {
      background: linear-gradient(135deg, #ffc107 0%, #ff8c00 100%);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      transform: translateY(-2px);
    }
    .token-button:hover:not(.selected) {
      background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
      transform: translateY(-1px);
    }
    .actions {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }
    .actions div {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        width: 100%;
        max-width: 300px;
        margin-bottom: 5px;
    }
    .actions label {
        font-weight: bold;
        white-space: nowrap;
    }
    .actions input[type="number"], .actions input[type="email"], .actions textarea {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      text-align: center;
      font-size: 0.9em;
      box-sizing: border-box;
    }
    .actions input[type="number"] {
        width: 60px;
    }
    .actions input[type="email"] {
        width: calc(100% - 60px);
        max-width: 250px;
        text-align: left;
    }
    .actions textarea {
        width: 100%;
        max-width: 400px;
        min-height: 70px;
        resize: vertical;
        text-align: left;
        font-size: 0.9em;
    }
    .actions button {
      padding: 10px 20px;
      font-size: 1em;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      margin: 5px;
    }
    #connect-btn {
      background: #6c757d;
      color: #fff;
    }
    #connect-btn:hover:not(:disabled) {
      background: #5a6268;
    }
    #connect-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    #mint-btn {
      background: #28a745;
      color: #fff;
    }
    #mint-btn:hover:not(:disabled) {
      background: #218838;
    }
    #mint-btn:disabled {
      cursor: not-allowed;
      opacity: 0.6;
    }
    .total-cost {
        font-size: 1.1em;
        font-weight: bold;
        color: #007bff;
        margin-top: 8px;
        margin-bottom: 8px;
    }
    .contact-section {
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 20px;
    }
    .contact-section h3 {
        color: #b22222;
        margin-bottom: 15px;
        font-size: 1.2em;
    }
    .contact-section button {
        background: #17a2b8;
        color: white;
        padding: 8px 15px;
        font-size: 0.9em;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        margin: 4px;
    }
    .contact-section button.whatsapp {
        background: #28a745;
    }
    .contact-section button:hover {
        opacity: 0.9;
    }

    #log {
      margin-top: 15px;
      padding: 12px;
      background: #e2e3e5;
      border-radius: 8px;
      min-height: 35px;
      font-size: 0.85em;
      color: #333;
      border: 1px solid #d6d8db;
    }

    /* Media queries per tablet e desktop */
    @media (min-width: 480px) { /* Tablet Portrait */
        body {
            padding: 15px;
        }
        .container {
            padding: 20px;
        }
        .header b {
            font-size: 1.6em;
        }
        .link {
            font-size: 0.95em;
        }
        .subtitle {
            font-size: 1em;
        }
        #preview {
            max-width: 250px;
            min-height: 200px;
        }
        .grid {
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* 3 colonne */
            gap: 12px;
        }
        .token-button {
            padding: 12px 18px;
            font-size: 1em;
        }
        .actions button {
            padding: 11px 22px;
            font-size: 1.05em;
        }
    }

    @media (min-width: 768px) { /* Tablet Landscape e Desktop */
        body {
            padding: 20px;
        }
        .container {
            padding: 25px;
        }
        .header b {
            font-size: 1.8em;
        }
        .link {
            margin: 5px 10px;
            font-size: 1em;
        }
        .subtitle {
            font-size: 1.1em;
        }
        #preview {
            max-width: 350px;
            min-height: 250px;
        }
      .grid {
          flex-direction: row;
          justify-content: center;
          align-items: center;
            grid-template-columns: repeat(4, 1fr); /* Forzo 4 colonne */
            gap: 15px;
      }
        .token-button {
            padding: 15px;
            font-size: 1.1em;
        }
      .actions {
          flex-direction: row;
          justify-content: center;
          align-items: center;
      }
      .actions input[type="number"] {
          margin-bottom: 0;
          margin-right: 10px;
      }
        .actions input[type="email"] {
            width: 250px;
        }
        .actions textarea {
            max-width: 400px;
            min-height: 80px;
        }
        .contact-section h3 {
            font-size: 1.3em;
        }
        .contact-section button {
            padding: 10px 20px;
            font-size: 1em;
        }
    }

    @media (min-width: 992px) { /* Desktop Large */
        .grid {
            grid-template-columns: repeat(6, 1fr); /* 6 colonne come richiesto se lo schermo è abbastanza grande */
            gap: 18px;
        }
        .token-button {
            padding: 18px;
        }
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <b>LHI Lecce MEDICAL HOTEL ITALIA Salento</b>
      <span class="crowdfunding-text">The First Crowdfunding International</span>
      <span class="blockchain-text">over Blockchain su rete POLYGON: Progetto scientifico di ricerca in corso:</span>
      <div class="scientific-project">
        <ul>
          <li><span class="green">Fibromialgia e Depressione:</span> <b>1)</b> Diagnosi; <b>2)</b> Cura; <b>3)</b> Guarigione</li>
        </ul>
      </div>
      <span class="call-to-action">Finanzia la ricerca e ricevi i tuoi NFT!</span>
      <a class="link" href="https://lhilecce.it" target="_blank">LHILECCE by Santa Rita Gestione.it</a>
      <a class="link" href="https://www.google.com/maps/place/LHI+HEALTHY+HUB/@40.3318151,18.1616335,3a,75y,90t/data=!3m8!1e2!3m6!1sCIABIhADydER2SP-MWf8rkYABe6e!2e10!3e12!6shttps:%2F%2Flh3.googleusercontent.com%2Fgps-cs-s%2FAC9h4noWbhcVXFPZRHKuF2iKmB4oNilfLiGNnYlTd-MqLR7NwSG818VQqOwf4fTFxWHbgQ3-cFNhUEcywJm4aM_b2SnaLrqRdoccfSatYFmwx9ZV9lgx8lX1V4liMgNZFG8ooqciktHLl74z7JY%3Dw203-h169-k-no!7i958!8i802!4m18!1m7!3m6!1s0x13442f3ec1afc225:0xae476d9edee74724!2sViale+Gino+Rizzo,+1,+73100+Lecce+LE!3b1!8m2!3d40.3315659!4d18.1606494!3m9!1s0x13442fc918b6d029:0x8ec95204297a6e3!5m2!4m1!1i2!8m2!3d40.3318171!4d18.1616302!10e5!16s%2Fg%2F11px8gr_q0?entry=ttu&g_ep=EgoyMDI1MDYxMC4xIKXMDSoASAFQAw%3D%3D#" target="_blank">Esplora Posizione GOOGLE MAPS</a>     </div>
    <img id="preview" src="" alt="Anteprima NFT" />

    <div class="popup-container" id="nft-popup">
        <img id="popup-img" src="" alt="NFT Popup Preview" />
        <p id="popup-status-text">Verifica in corso...</p>
        <div id="confirmSection">
            <button id="confirm-nft-btn">Conferma NFT e Ottieni Chiave</button>
            <button id="popup-close-btn">Chiudi</button>
        </div>
    </div>
    <div class="overlay" id="popup-overlay"></div>

    <div class="grid" id="button-container"></div>
    <div class="actions">
      <button id="connect-btn">Connetti Metamask</button>
      <div>
        <label for="quantity">Quantità:</label>
        <input type="number" id="quantity" value="1" min="1" max="100" />
      </div>
      <div class="total-cost" id="total-cost-display">
        Costo totale: 0 MATIC
      </div>
      <button id="mint-btn" disabled>Mint NFT</button>
    </div>

    <div class="contact-section">
        <h3>Contatta LHI Lecce</h3>
        <div>
            <label for="sender-email">La tua Email:</label>
            <input type="email" id="sender-email" placeholder="tua.email@example.com">
        </div>
        <div>
            <label for="email-request">La tua Richiesta (max 300 caratteri):</label>
            <textarea id="email-request" maxlength="300" placeholder="Scrivi qui la tua richiesta..."></textarea>
        </div>
        <button id="send-email-btn">Invia Email</button>
        <button id="send-whatsapp-btn" class="whatsapp">Invia Messaggio WhatsApp</button>
    </div>

    <div id="log">Status: In attesa di connessione...</div>
  </div>
  <script>
    // --- Variabili Globali ---
    const contractAddress = "0x6a6d5dc29ad8ff23209186775873e123b31c26e9";
    const contractABI = [
        // Incolla qui l'ABI completo che mi hai fornito
        {"inputs":[{"internalType":"string","name":"_baseURI","type":"string"},{"internalType":"address","name":"_owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"uint256","name":"balance","type":"uint256"},{"internalType":"uint256","name":"needed","type":"uint256"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ERC1155InsufficientBalance","type":"error"},{"inputs":[{"internalType":"address","name":"approver","type":"address"}],"name":"ERC1155InvalidApprover","type":"error"},{"inputs":[{"internalType":"uint256","name":"idsLength","type":"uint256"},{"internalType":"uint256","name":"valuesLength","type":"uint256"}],"name":"ERC1155InvalidArrayLength","type":"error"},{"inputs":[{"internalType":"address","name":"operator","type":"address"}],"name":"ERC1155InvalidOperator","type":"error"},{"inputs":[{"internalType":"address","name":"receiver","type":"address"}],"name":"ERC1155InvalidReceiver","type":"error"},{"inputs":[{"internalType":"address","name":"sender","type":"address"}],"name":"ERC1155InvalidSender","type":"error"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"address","name":"owner","type":"address"}],"name":"ERC1155MissingApprovalForAll","type":"error"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"OwnableInvalidOwner","type":"error"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"OwnableUnauthorizedAccount","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"account","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"newBaseURI","type":"string"}],"name":"BaseURIUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"},{"indexed":true,"internalType":"address","name":"requester","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"BurnApproved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"},{"indexed":true,"internalType":"address","name":"requester","type":"address"},{"indexed":false,"internalType":"uint256", "name": "tokenId", "type": "uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"BurnDenied", "type": "event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"requester","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"requestId","type":"uint256"}],"name":"BurnRequested","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"FundsWithdrawn","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"NFTBurned", "type": "event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"tokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"price","type":"uint256"},{"indexed":false,"internalType":"string","name":"encryptedURI","type":"string"}],"name":"NFTMinted", "type": "event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred", "type": "event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from", "type": "address"},{"indexed":true,"internalType":"address","name":"to", "type": "address"},{"indexed":false,"internalType":"uint256[]","name":"ids", "type": "uint256[]"},{"indexed":false,"internalType":"uint256[]","name":"values", "type": "uint256[]"}],"name":"TransferBatch", "type": "event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":true,"internalType":"address","name":"from", "type": "address"},{"indexed":true,"internalType":"address","name":"to", "type": "address"},{"indexed":false,"internalType":"uint256", "name": "id", "type": "uint256"},{"indexed":false,"internalType":"uint256", "name": "value", "type": "uint256"}],"name":"TransferSingle", "type": "event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"value", "type": "string"},{"indexed":true,"internalType":"uint256","name":"id", "type": "uint256"}],"name":"URI", "type": "event"},{"inputs":[],"name":"MINIMUM_TOTAL_VALUE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"requestId","type":"uint256"},{"internalType":"bool","name":"approve","type":"bool"}],"name":"approveBurn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"accounts","type":"address[]"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"}],"name":"balanceOfBatch","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"burnRequests","outputs":[{"internalType":"address","name":"requester","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"},{"internalType":"bool","name":"approved","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"calculateTotalValueAfterBurn","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getEncryptedURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"isValidTokenId","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"maxSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"mintNFT","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"onlyOwnerFunction","outputs":[],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"pricesInWei","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"requestBurn","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256[]","name":"ids","type":"uint256[]"},{"internalType":"uint256[]","name":"values","type":"uint256[]"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeBatchTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"value","type":"uint256"},{"internalType":"bytes","name":"data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"newBaseURI","type":"string"}],"name":"setBaseURI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"string","name":"cid","type":"string"}],"name":"setTokenCID","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"totalMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"uri","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawFunds","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawWallet","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"}
    ];

    let selectedTokenId = null;
    let selectedImageUrl = "";
    let currentProvider;
    let currentSigner;
    let contractInstance;

    const logElement = document.getElementById('log');
    const connectBtn = document.getElementById('connect-btn');
    const mintBtn = document.getElementById('mint-btn');
    const quantityInput = document.getElementById('quantity');
    const totalCostDisplay = document.getElementById('total-cost-display');
    const senderEmailInput = document.getElementById('sender-email');
    const emailRequestTextarea = document.getElementById('email-request');
    const sendEmailBtn = document.getElementById('send-email-btn');
    const sendWhatsappBtn = document.getElementById('send-whatsapp-btn');
    const preview = document.getElementById('preview');
    const buttonContainer = document.getElementById('button-container');

    // Elementi del popup
    const nftPopup = document.getElementById('nft-popup');
    const popupOverlay = document.getElementById('popup-overlay');
    const popupImg = document.getElementById('popup-img');
    const popupStatusText = document.getElementById('popup-status-text');
    const confirmSection = document.getElementById('confirmSection');
    const confirmNftBtn = document.getElementById('confirm-nft-btn');
    const popupCloseBtn = document.getElementById('popup-close-btn');

    function updateLog(message, type = 'info') {
        logElement.textContent = `Status: ${message}`;
        logElement.className = '';
        if (type === 'error') logElement.classList.add('red');
        if (type === 'success') logElement.classList.add('green');
        if (type === 'warning') logElement.classList.add('darkgreen');
    }

    async function updateTotalPriceDisplay() {
        if (selectedTokenId !== null && contractInstance) {
            try {
                const pricePerNFTInWei = await contractInstance.pricesInWei(selectedTokenId);
                const quantity = parseInt(quantityInput.value);
                if (!isNaN(quantity) && quantity > 0) {
                    const totalCostInWei = pricePerNFTInWei.mul(quantity);
                    const totalCostInMatic = ethers.utils.formatEther(totalCostInWei);
                    totalCostDisplay.textContent = `Costo totale: ${totalCostInMatic} MATIC`;
                } else {
                    totalCostDisplay.textContent = `Costo totale: 0 MATIC`;
                }
            } catch (error) {
                console.error("Errore nel calcolo del prezzo totale:", error);
                totalCostDisplay.textContent = `Costo totale: Errore`;
            }
        } else {
            totalCostDisplay.textContent = `Costo totale: 0 MATIC`;
        }
    }

    // Funzione per la connessione a Metamask
    async function connectMetamask() {
        if (typeof window.ethereum === 'undefined') {
            updateLog("Metamask non è installato o non rilevato.", 'error');
            // Questo alert è fondamentale per istruire l'utente sul mobile
            alert("Per interagire con gli NFT, è necessario un wallet Web3 (come Metamask o Coinbase Wallet).\n\nSe sei su smartphone, prova ad aprire questa pagina direttamente dal browser interno del tuo wallet (es. Metamask, Trust Wallet, Coinbase Wallet).");
            return;
        }

        try {
            updateLog("Connessione a Metamask in corso...");
            currentProvider = new ethers.providers.Web3Provider(window.ethereum);
            await currentProvider.send("eth_requestAccounts", []); // Richiede connessione
            currentSigner = currentProvider.getSigner();
            const userAddress = await currentSigner.getAddress();
            contractInstance = new ethers.Contract(contractAddress, contractABI, currentSigner);

            updateLog(`Wallet connesso: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`, 'success');
            connectBtn.textContent = `Connesso: ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
            connectBtn.disabled = true;
            mintBtn.disabled = selectedTokenId === null;

            updateTotalPriceDisplay();

            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    updateLog("Wallet disconnesso.", 'warning');
                    connectBtn.textContent = "Connetti Metamask";
                    connectBtn.disabled = false;
                    mintBtn.disabled = true;
                    totalCostDisplay.textContent = `Costo totale: 0 MATIC`;
                } else {
                    updateLog(`Account cambiato a: ${accounts[0].substring(0, 6)}...${accounts[0].substring(accounts[0].length - 4)}`, 'success');
                    connectBtn.textContent = `Connesso: ${accounts[0].substring(0, 6)}...${accounts[0].substring(accounts[0].length - 4)}`;
                    updateTotalPriceDisplay();
                }
            });

            window.ethereum.on('chainChanged', (chainId) => {
                if (chainId !== '0x89') { // ID della catena di Polygon Mainnet è 0x89 (137 in decimale)
                    updateLog("Rete cambiata. Passa a Polygon Mainnet.", 'warning');
                    mintBtn.disabled = true;
                    totalCostDisplay.textContent = `Costo totale: 0 MATIC`;
                } else {
                    updateLog("Connesso a Polygon Mainnet.", 'success');
                    mintBtn.disabled = selectedTokenId === null;
                    updateTotalPriceDisplay();
                }
            });


        } catch (error) {
            console.error("Errore durante la connessione a Metamask:", error);
            if (error.code === 4001) {
                updateLog("Connessione a Metamask rifiutata dall'utente.", 'error');
            } else {
                updateLog(`Errore di connessione: ${error.message || error.code}`, 'error');
            }
        }
    }

    // Funzione per il mint dell'NFT
    async function mintNFT() {
        if (!currentSigner || !contractInstance) {
            updateLog("Wallet non connesso. Si prega di connettere Metamask prima.", 'error');
            return;
        }
        if (selectedTokenId === null) {
            updateLog("Si prega di selezionare un NFT da coniare.", 'error');
            return;
        }

        const quantity = parseInt(quantityInput.value);
        if (isNaN(quantity) || quantity <= 0) {
            updateLog("Quantità non valida. Inserire un numero maggiore di 0.", 'error');
            return;
        }

        updateLog("Calcolo del prezzo e preparazione transazione...", 'info');
        try {
            // Leggi il prezzo dal contratto per il tokenId selezionato
            const priceInWei = await contractInstance.pricesInWei(selectedTokenId);
            const totalCostInWei = priceInWei.mul(quantity); // Moltiplica per la quantità
            const totalCostInMatic = ethers.utils.formatEther(totalCostInWei);

            updateLog(`Tentativo di mint di ${quantity} NFT (ID: ${selectedTokenId}) per un costo totale di ${totalCostInMatic} MATIC...`, 'warning');

            // Esegui la transazione di mint
            const tx = await contractInstance.mintNFT(
                selectedTokenId,
                quantity,
                { value: totalCostInWei }
            );

            updateLog(`Transazione inviata! Hash: ${tx.hash}\nIn attesa di conferma...`, 'info');
            
            // Disabilita il pulsante di mint durante la transazione
            mintBtn.disabled = true;

            const receipt = await tx.wait();
            updateLog("NFT mintato con successo! Transazione confermata.", 'success');
            console.log("Transazione confermata:", receipt);
            // Dopo il mint, apri il popup per la verifica
            openNftPopup(selectedImageUrl, selectedTokenId); // Passa l'immagine selezionata e l'ID

            mintBtn.disabled = false; // Riabilita dopo la conferma

        } catch (error) {
            console.error("Errore durante il mint dell'NFT:", error);
            if (error.code === 4001) {
                updateLog("Transazione rifiutata dall'utente in Metamask.", 'error');
            } else if (error.message.includes("Incorrect ETH amount")) {
                updateLog("Errore: Importo MATIC inviato non corrisponde al prezzo richiesto.", 'error');
            } else if (error.message.includes("insufficient funds")) {
                updateLog("Errore: Fondi insufficienti nel tuo wallet per coprire la transazione e il gas.", 'error');
            } else if (error.message.includes("Exceeds max supply")) {
                updateLog("Errore: Hai tentato di mintare più NFT di quelli disponibili per questo tipo.", 'error');
            } else if (error.message.includes("Invalid tokenId")) {
                updateLog("Errore: ID del token non valido o non disponibile per il mint.", 'error');
            } else {
                updateLog(`Errore durante il mint: ${error.message || error.code}`, 'error');
            }
            mintBtn.disabled = false; // Riabilita in caso di errore
        }
    }

    // Funzione per inviare email (apre client email dell'utente)
    function sendEmail() {
        const recipientEmail = 'servizioclienti@lhilecce.it';
        const senderEmail = senderEmailInput.value;
        const requestMessage = emailRequestTextarea.value;
        const subject = encodeURIComponent('Richiesta da LHI Lecce NFT Frontend');
        const body = encodeURIComponent(`Mittente: ${senderEmail}\n\nMessaggio:\n${requestMessage}`);

        if (!senderEmail || !requestMessage) {
            alert("Per favore, inserisci la tua email e la richiesta.");
            return;
        }

        const mailtoLink = `mailto:${recipientEmail}?subject=${subject}&body=${body}`;
        window.location.href = mailtoLink;
        alert("La tua email è stata preparata! Si aprirà il tuo client di posta. Clicca invia da lì.");
        updateLog("Email preparata per l'invio.", 'success');
    }

    // Funzione per inviare messaggio WhatsApp (apre WhatsApp dell'utente)
    function sendWhatsapp() {
        const whatsappNumber = '+393294550111'; // <-- Numero di telefono configurato
        const requestMessage = emailRequestTextarea.value;
        const encodedMessage = encodeURIComponent(`Messaggio di assistenza da LHI Lecce NFT Frontend:\n${requestMessage}`);

        if (!requestMessage) {
            alert("Per favore, inserisci il messaggio per WhatsApp.");
            return;
        }
        if (whatsappNumber === 'NUMERO_DI_TELEFONO_ASSISTENZA') {
            alert("Il numero di telefono per WhatsApp non è ancora stato configurato. Si prega di contattare LHI Lecce tramite email.");
            return;
        }

        const whatsappLink = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
        window.open(whatsappLink, '_blank');
        alert("Il tuo messaggio è stato inviato a WhatsApp, grazie! Si aprirà l'app. Clicca invia da lì.");
        updateLog("Messaggio WhatsApp preparato per l'invio.", 'success');
    }

    // --- Logica del Popup (Integrata dal tuo codice) ---
    // Funzione per aprire il popup dell'NFT
    async function openNftPopup(imageUrl, tokenId) {
        popupImg.src = imageUrl;
        popupStatusText.textContent = "Verifica in corso...";
        confirmSection.style.display = 'none';
        nftPopup.style.display = 'block';
        popupOverlay.style.display = 'block';

        if (currentSigner) {
            try {
                const userAddress = await currentSigner.getAddress();
                popupStatusText.textContent = `Verifica in corso per NFT ID ${tokenId} di ${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                
                // Simula un ritardo o una chiamata a un backend per la verifica
                setTimeout(() => {
                    popupStatusText.textContent = `Verifica completata. Clicca per ottenere la chiave di decifrazione.`;
                    confirmSection.style.display = 'block';
                }, 2000);
            } catch (error) {
                console.error("Errore nel recuperare l'indirizzo per il popup:", error);
                popupStatusText.textContent = "Errore nella verifica dell'utente.";
                confirmSection.style.display = 'none';
            }
        } else {
            popupStatusText.textContent = "Connetti Metamask per la verifica.";
            confirmSection.style.display = 'none';
        }
    }

    // Funzione per chiudere il popup dell'NFT
    function closeNftPopup() {
        nftPopup.style.display = 'none';
        popupOverlay.style.display = 'none';
        popupImg.src = "";
        popupStatusText.textContent = "";
        confirmSection.style.display = 'none';
    }

    // Funzione per confermare l'NFT e chiamare il backend per la chiave
    async function confirmNFTAndGetKey() {
        if (!currentSigner || !selectedTokenId) {
            alert("Errore: Nessun token selezionato o wallet non connesso.");
            return;
        }

        const address = await currentSigner.getAddress();
        const tokenId = selectedTokenId.toString();

        popupStatusText.textContent = "Richiesta chiave al backend...";
        confirmNftBtn.disabled = true;

        try {
            const response = await fetch('https://lhileccenft.herokuapp.com/get-key', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address, tokenId }),
            });

            const data = await response.json();

            if (response.ok && data.success) {
                alert("NFT confermato! Chiave ricevuta: " + data.key + "\nOra puoi usare questa chiave per decifrare l'immagine.");
                popupStatusText.textContent = "Chiave ricevuta con successo!";
            } else {
                alert("Errore nell'ottenere la chiave: " + (data.error || "Errore sconosciuto."));
                popupStatusText.textContent = "Errore nell'ottenere la chiave.";
            }
        } catch (err) {
            alert("Errore nella richiesta al backend: " + err.message);
            popupStatusText.textContent = "Errore di connessione al backend.";
            console.error("Errore nella richiesta al backend:", err);
        } finally {
            confirmNftBtn.disabled = false;
            closeNftPopup();
        }
    }


    // --- Inizializzazione UI e Gestione Pulsanti Token ---
    const tokenRange = Array.from({ length: 20 }, (_, i) => (i + 1) * 5); // Genera 5, 10, ..., 100

    window.onload = function() {
        tokenRange.forEach(val => {
            const btn = document.createElement("button");
            btn.textContent = `NFT ${val} - ${0.5 * val} MATIC`;
            btn.className = "token-button";
            btn.dataset.tokenId = val;
            btn.onclick = async () => {
                // Rimuovi la classe 'selected' da tutti i pulsanti
                document.querySelectorAll('.token-button').forEach(b => b.classList.remove('selected'));
                // Aggiungi la classe 'selected' al pulsante cliccato
                btn.classList.add('selected');

                selectedTokenId = val;
                // Carica l'immagine nell'anteprima principale
                mintBtn.disabled = currentSigner ? false : true;

                const padded = val.toString().padStart(2, '0');
                const baseUrl = `https://avvstancamarcello.github.io/LHISA-lecce-Italy-salento/images/`;
                const tryLower = `${baseUrl}${padded}.jpg`;
                const tryUpper = `${baseUrl}${padded}.JPG`;

                let imageUrl = "";
                try {
                    const res = await fetch(tryLower, { method: "HEAD" });
                    if (res.ok) {
                        imageUrl = tryLower;
                    } else {
                        const res2 = await fetch(tryUpper, { method: "HEAD" });
                        if (res2.ok) {
                            imageUrl = tryUpper;
                        }
                    }
                } catch (error) {
                    console.error(`Errore nel tentativo di caricamento immagine per token ${val}:`, error);
                }

                if (imageUrl) {
                    preview.src = imageUrl;
                    selectedImageUrl = imageUrl;
                } else {
                    preview.src = "";
                    selectedImageUrl = "";
                    console.warn(`Immagine non trovata per token ${val}`);
                }
                updateTotalPriceDisplay();
            };
            buttonContainer.appendChild(btn);
        });

        quantityInput.addEventListener('input', updateTotalPriceDisplay);
        connectBtn.addEventListener('click', connectMetamask);
        mintBtn.addEventListener('click', mintNFT);
        sendEmailBtn.addEventListener('click', sendEmail);
        sendWhatsappBtn.addEventListener('click', sendWhatsapp);

        // Listener per aprire il popup cliccando sull'immagine di preview principale
        preview.addEventListener('click', () => {
            if (selectedTokenId !== null && selectedImageUrl !== "") {
                openNftPopup(selectedImageUrl, selectedTokenId);
            } else {
                alert("Seleziona prima un NFT per visualizzare l'anteprima grande.");
            }
        });
        // Listener per i pulsanti del popup
        confirmNftBtn.addEventListener('click', confirmNFTAndGetKey);
        popupCloseBtn.addEventListener('click', closeNftPopup);
        popupOverlay.addEventListener('click', closeNftPopup);


        mintBtn.disabled = true;
        updateLog("In attesa di connessione Metamask...", 'info');

        if (window.ethereum && window.ethereum.selectedAddress) {
            connectMetamask();
        }
        updateTotalPriceDisplay();
    };
  </script>
</body>
</html>
